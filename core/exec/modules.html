
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Modules &#8212; WebAssembly 3.0 (Draft 2024-07-29)</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script>window.MathJax = {"tex": {"maxBuffer": 30720}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Binary Format" href="../binary/index.html" />
    <link rel="prev" title="Instructions" href="instructions.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/webassembly.png" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syntax/index.html">Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../valid/index.html">Validation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Execution</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="conventions.html">Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="runtime.html">Runtime Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="numerics.html">Numerics</a></li>
<li class="toctree-l2"><a class="reference internal" href="types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="values.html">Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="instructions.html">Instructions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../binary/index.html">Binary Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../text/index.html">Text Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index-types.html">Index of Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index-instructions.html">Index of Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index-rules.html">Index of Semantic Rules</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="../genindex.html">Index</a></li>
    
    <li class="toctree-l1"><a href="../_download/WebAssembly.pdf">Download as PDF</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="modules">
<h1>Modules<a class="headerlink" href="#modules" title="Permalink to this heading">¶</a></h1>
<p>For modules, the execution semantics primarily defines <a class="reference internal" href="#exec-instantiation"><span class="std std-ref">instantiation</span></a>, which <a class="reference internal" href="#alloc"><span class="std std-ref">allocates</span></a> instances for a module and its contained definitions, initializes <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">tables</span></a> and <a class="reference internal" href="../syntax/modules.html#syntax-mem"><span class="std std-ref">memories</span></a> from contained <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element</span></a> and <a class="reference internal" href="../syntax/modules.html#syntax-data"><span class="std std-ref">data</span></a> segments, and invokes the <a class="reference internal" href="../syntax/modules.html#syntax-start"><span class="std std-ref">start function</span></a> if present. It also includes <a class="reference internal" href="#exec-invocation"><span class="std std-ref">invocation</span></a> of exported functions.</p>
<section id="allocation">
<span id="alloc"></span><span id="index-0"></span><h2>Allocation<a class="headerlink" href="#allocation" title="Permalink to this heading">¶</a></h2>
<p>New instances of <a class="reference internal" href="runtime.html#syntax-funcinst"><span class="std std-ref">functions</span></a>, <a class="reference internal" href="runtime.html#syntax-tableinst"><span class="std std-ref">tables</span></a>, <a class="reference internal" href="runtime.html#syntax-meminst"><span class="std std-ref">memories</span></a>, and <a class="reference internal" href="runtime.html#syntax-globalinst"><span class="std std-ref">globals</span></a> are <em>allocated</em> in a <a class="reference internal" href="runtime.html#syntax-store"><span class="std std-ref">store</span></a> <span class="math notranslate nohighlight">\(s\)</span>, as defined by the following auxiliary functions.</p>
<section id="functions">
<span id="alloc-func"></span><span id="index-1"></span><h3><a class="reference internal" href="runtime.html#syntax-funcinst"><span class="std std-ref">Functions</span></a><a class="headerlink" href="#functions" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-func}{\mathit{func}}\)</span> be the <a class="reference internal" href="../syntax/modules.html#syntax-func"><span class="std std-ref">function</span></a> to allocate and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> its <a class="reference internal" href="runtime.html#syntax-moduleinst"><span class="std std-ref">module instance</span></a>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}\)</span> be the <a class="reference internal" href="../valid/conventions.html#syntax-deftype"><span class="std std-ref">defined type</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}.\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{types}}[\href{../syntax/modules.html#syntax-func}{\mathit{func}}.\href{../syntax/modules.html#syntax-func}{\mathsf{type}}]\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-funcaddr"><span class="std std-ref">function address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-funcinst"><span class="std std-ref">function instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-funcinst}{\mathsf{type}}~\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}, \href{../exec/runtime.html#syntax-funcinst}{\mathsf{module}}~\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}, \href{../exec/runtime.html#syntax-funcinst}{\mathsf{code}}~\href{../syntax/modules.html#syntax-func}{\mathit{func}} \}\)</span>.</p></li>
</ol>
<ol class="arabic simple" start="6">
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-func}{\mathrm{allocfunc}}}(s, {\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}}, {{\href{../exec/runtime.html#syntax-funcinst}{\mathit{code}}}}, {\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}~{\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-funcinst}{\mathsf{type}}~{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}},\; \href{../exec/runtime.html#syntax-funcinst}{\mathsf{module}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}},\; \href{../exec/runtime.html#syntax-funcinst}{\mathsf{code}}~{{\href{../exec/runtime.html#syntax-funcinst}{\mathit{code}}}} \}\end{array}} \\
\end{array}\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Host functions are never allocated by the WebAssembly semantics itself,
but may be allocated by the <a class="reference internal" href="../intro/overview.html#embedder"><span class="std std-ref">embedder</span></a>.</p>
</div>
</section>
<section id="tables">
<span id="alloc-table"></span><span id="index-2"></span><h3><a class="reference internal" href="runtime.html#syntax-tableinst"><span class="std std-ref">Tables</span></a><a class="headerlink" href="#tables" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-tabletype"><span class="std std-ref">table type</span></a> of the table to allocate and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}\)</span> the initialization value.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\((\{\href{../syntax/types.html#syntax-limits}{\mathsf{min}}~n, \href{../syntax/types.html#syntax-limits}{\mathsf{max}}~m^?\}~\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}})\)</span> be the structure of <a class="reference internal" href="../syntax/types.html#syntax-tabletype"><span class="std std-ref">table type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-tableaddr"><span class="std std-ref">table address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-tableinst"><span class="std std-ref">table instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}~\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}', \href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}~\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^n \}\)</span> with <span class="math notranslate nohighlight">\(n\)</span> elements set to <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}\)</span>.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{tables}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-table}{\mathrm{alloctable}}}(s, {}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~{\mathit{rt}}, {\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{tables}}~{\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{tables}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}~({}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~{\mathit{rt}}),\; \href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}~{{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}^{i}} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
<section id="memories">
<span id="alloc-mem"></span><span id="index-3"></span><h3><a class="reference internal" href="runtime.html#syntax-meminst"><span class="std std-ref">Memories</span></a><a class="headerlink" href="#memories" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-memtype"><span class="std std-ref">memory type</span></a> of the memory to allocate.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\{\href{../syntax/types.html#syntax-limits}{\mathsf{min}}~n, \href{../syntax/types.html#syntax-limits}{\mathsf{max}}~m^?\}\)</span> be the structure of <a class="reference internal" href="../syntax/types.html#syntax-memtype"><span class="std std-ref">memory type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-memaddr"><span class="std std-ref">memory address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-meminst"><span class="std std-ref">memory instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}~\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}, \href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}~(\def\mathdef1931#1{\mathtt{0x#1}}\mathdef1931{00})^{n \cdot 64\,\mathrm{Ki}} \}\)</span> that contains <span class="math notranslate nohighlight">\(n\)</span> pages of zeroed <a class="reference internal" href="../syntax/values.html#syntax-byte"><span class="std std-ref">bytes</span></a>.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{mems}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-mem}{\mathrm{allocmem}}}(s, {}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~\href{../syntax/types.html#syntax-memtype}{\mathsf{page}}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{mems}}~{\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{mems}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}~({}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~\href{../syntax/types.html#syntax-memtype}{\mathsf{page}}),\; \href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}~{(\mathtt{0x00})^{i \cdot 64 \, {\mathrm{Ki}}}} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
<section id="globals">
<span id="alloc-global"></span><span id="index-4"></span><h3><a class="reference internal" href="runtime.html#syntax-globalinst"><span class="std std-ref">Globals</span></a><a class="headerlink" href="#globals" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-globaltype"><span class="std std-ref">global type</span></a> of the global to allocate and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}\)</span> its initialization <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">value</span></a>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-globaladdr"><span class="std std-ref">global address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globalinst}{\mathit{globalinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-globalinst"><span class="std std-ref">global instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-globalinst}{\mathsf{type}}~\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}, \href{../exec/runtime.html#syntax-globalinst}{\mathsf{value}}~\href{../exec/runtime.html#syntax-val}{\mathit{val}} \}\)</span>.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globalinst}{\mathit{globalinst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{globals}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-global}{\mathrm{allocglobal}}}(s, {\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}}, {\href{../exec/runtime.html#syntax-val}{\mathit{val}}}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{globals}}~{\href{../exec/runtime.html#syntax-globalinst}{\mathit{globalinst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{globals}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-globalinst}{\mathit{globalinst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-globalinst}{\mathsf{type}}~{\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}},\; \href{../exec/runtime.html#syntax-globalinst}{\mathsf{value}}~{\href{../exec/runtime.html#syntax-val}{\mathit{val}}} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
<section id="element-segments">
<span id="alloc-elem"></span><span id="index-5"></span><h3><a class="reference internal" href="runtime.html#syntax-eleminst"><span class="std std-ref">Element segments</span></a><a class="headerlink" href="#element-segments" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}}\)</span> be the elements’ type and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^\ast\)</span> the list of <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">references</span></a> to allocate.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-elemaddr"><span class="std std-ref">element address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-eleminst}{\mathit{eleminst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-eleminst"><span class="std std-ref">element instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-eleminst}{\mathsf{type}}~\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}}, \href{../exec/runtime.html#syntax-eleminst}{\mathsf{elem}}~\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^\ast \}\)</span>.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-eleminst}{\mathit{eleminst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{elems}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-elem}{\mathrm{allocelem}}}(s, {\href{../syntax/types.html#syntax-elemtype}{\mathit{elemtype}}}, {{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}^\ast}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{elems}}~{\href{../exec/runtime.html#syntax-eleminst}{\mathit{eleminst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{elems}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-eleminst}{\mathit{eleminst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-eleminst}{\mathsf{type}}~{\href{../syntax/types.html#syntax-elemtype}{\mathit{elemtype}}},\; \href{../exec/runtime.html#syntax-eleminst}{\mathsf{elem}}~{{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}^\ast} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
<section id="data-segments">
<span id="alloc-data"></span><span id="index-6"></span><h3><a class="reference internal" href="runtime.html#syntax-datainst"><span class="std std-ref">Data segments</span></a><a class="headerlink" href="#data-segments" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(b^\ast\)</span> be the list of <a class="reference internal" href="../syntax/values.html#syntax-byte"><span class="std std-ref">bytes</span></a> to allocate.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(a\)</span> be the first free <a class="reference internal" href="runtime.html#syntax-dataaddr"><span class="std std-ref">data address</span></a> in <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-datainst}{\mathit{datainst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-datainst"><span class="std std-ref">data instance</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-datainst}{\mathsf{bytes}}~b^\ast \}\)</span>.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-datainst}{\mathit{datainst}}\)</span> to the <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-store}{\mathsf{datas}}\)</span> of <span class="math notranslate nohighlight">\(S\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(a\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-data}{\mathrm{allocdata}}}(s, \href{../valid/modules.html#valid-data}{\mathsf{ok}}, {{\href{../syntax/values.html#syntax-byte}{\mathit{byte}}}^\ast}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s \oplus \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-store}{\mathsf{datas}}~{\href{../exec/runtime.html#syntax-datainst}{\mathit{datainst}}} \}\end{array}, {|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{datas}}|}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../exec/runtime.html#syntax-datainst}{\mathit{datainst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-datainst}{\mathsf{bytes}}~{{\href{../syntax/values.html#syntax-byte}{\mathit{byte}}}^\ast} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
<section id="growing-tables">
<span id="grow-table"></span><span id="index-7"></span><h3>Growing <a class="reference internal" href="runtime.html#syntax-tableinst"><span class="std std-ref">tables</span></a><a class="headerlink" href="#growing-tables" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-tableinst"><span class="std std-ref">table instance</span></a> to grow, <span class="math notranslate nohighlight">\(n\)</span> the number of elements by which to grow it, and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}\)</span> the initialization value.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\mathit{len}\)</span> be <span class="math notranslate nohighlight">\(n\)</span> added to the length of <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}.\href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}\)</span>.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\mathit{len}\)</span> is larger than or equal to <span class="math notranslate nohighlight">\(2^{32}\)</span>, then fail.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}~t\)</span> be the structure of <a class="reference internal" href="../syntax/types.html#syntax-tabletype"><span class="std std-ref">table type</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}.\href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'\)</span> be <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}\)</span> with <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathsf{min}}\)</span> updated to <span class="math notranslate nohighlight">\(\mathit{len}\)</span>.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'\)</span> is not <a class="reference internal" href="../valid/types.html#valid-limits"><span class="std std-ref">valid</span></a>, then fail.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^n\)</span> to <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}.\href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}\)</span>.</p></li>
<li><p>Set <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}.\href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}\)</span> to the <a class="reference internal" href="../syntax/types.html#syntax-tabletype"><span class="std std-ref">table type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'~t\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#grow-table}{\mathrm{growtable}}}({\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}}, n, r) &amp;=&amp; {\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}'}
  &amp;\qquad \mbox{if}~{\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}~({}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~{\mathit{rt}}),\; \href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}~{{r'}^\ast} \}\end{array} \\
  &amp;&amp;&amp;\qquad {\land}~{\href{../exec/runtime.html#syntax-tableinst}{\mathit{tableinst}}'} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-tableinst}{\mathsf{type}}~({}[ {i'} \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~{\mathit{rt}}),\; \href{../exec/runtime.html#syntax-tableinst}{\mathsf{elem}}~{{r'}^\ast}~{r^{n}} \}\end{array} \\
  &amp;&amp;&amp;\qquad {\land}~{i'} = {|{{r'}^\ast}|} + n \leq j \\
\end{array}\end{split}\]</div>
</section>
<section id="growing-memories">
<span id="grow-mem"></span><span id="index-8"></span><h3>Growing <a class="reference internal" href="runtime.html#syntax-meminst"><span class="std std-ref">memories</span></a><a class="headerlink" href="#growing-memories" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-meminst"><span class="std std-ref">memory instance</span></a> to grow and <span class="math notranslate nohighlight">\(n\)</span> the number of <a class="reference internal" href="runtime.html#page-size"><span class="std std-ref">pages</span></a> by which to grow it.</p></li>
<li><p>Assert: The length of <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}.\href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}\)</span> is divisible by the <a class="reference internal" href="runtime.html#page-size"><span class="std std-ref">page size</span></a> <span class="math notranslate nohighlight">\(64\,\mathrm{Ki}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\mathit{len}\)</span> be <span class="math notranslate nohighlight">\(n\)</span> added to the length of <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}.\href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}\)</span> divided by the <a class="reference internal" href="runtime.html#page-size"><span class="std std-ref">page size</span></a> <span class="math notranslate nohighlight">\(64\,\mathrm{Ki}\)</span>.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\mathit{len}\)</span> is larger than <span class="math notranslate nohighlight">\(2^{16}\)</span>, then fail.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}\)</span> be the structure of <a class="reference internal" href="../syntax/types.html#syntax-memtype"><span class="std std-ref">memory type</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}.\href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'\)</span> be <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}\)</span> with <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathsf{min}}\)</span> updated to <span class="math notranslate nohighlight">\(\mathit{len}\)</span>.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'\)</span> is not <a class="reference internal" href="../valid/types.html#valid-limits"><span class="std std-ref">valid</span></a>, then fail.</p></li>
<li><p>Append <span class="math notranslate nohighlight">\(n\)</span> times <span class="math notranslate nohighlight">\(64\,\mathrm{Ki}\)</span> <a class="reference internal" href="../syntax/values.html#syntax-byte"><span class="std std-ref">bytes</span></a> with value <span class="math notranslate nohighlight">\(\def\mathdef1932#1{\mathtt{0x#1}}\mathdef1932{00}\)</span> to <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}.\href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}\)</span>.</p></li>
<li><p>Set <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}.\href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}\)</span> to the <a class="reference internal" href="../syntax/types.html#syntax-memtype"><span class="std std-ref">memory type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}'\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#grow-mem}{\mathrm{growmem}}}({\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}}, n) &amp;=&amp; {\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}'}
  &amp;\qquad \mbox{if}~{\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}~({}[ i \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~\href{../syntax/types.html#syntax-memtype}{\mathsf{page}}),\; \href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}~{b^\ast} \}\end{array} \\
  &amp;&amp;&amp;\qquad {\land}~{\href{../exec/runtime.html#syntax-meminst}{\mathit{meminst}}'} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-meminst}{\mathsf{type}}~({}[ {i'} \href{../syntax/types.html#syntax-limits}{\,{..}\,} j ]~\href{../syntax/types.html#syntax-memtype}{\mathsf{page}}),\; \href{../exec/runtime.html#syntax-meminst}{\mathsf{bytes}}~{b^\ast}~{(\mathtt{0x00})^{n \cdot 64 \, {\mathrm{Ki}}}} \}\end{array} \\
  &amp;&amp;&amp;\qquad {\land}~{i'} = {|{b^\ast}|} / (64 \, {\mathrm{Ki}}) + n \leq j \\
\end{array}\end{split}\]</div>
</section>
<section id="alloc-module">
<span id="index-9"></span><span id="id1"></span><h3><a class="reference internal" href="runtime.html#syntax-moduleinst"><span class="std std-ref">Modules</span></a><a class="headerlink" href="#alloc-module" title="Permalink to this heading">¶</a></h3>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>update prose for types</p>
</div>
<p>The allocation function for <a class="reference internal" href="../syntax/modules.html#syntax-module"><span class="std std-ref">modules</span></a> requires a suitable list of <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external values</span></a> that are assumed to <a class="reference internal" href="../valid/matching.html#match-externtype"><span class="std std-ref">match</span></a> the <a class="reference internal" href="../syntax/modules.html#syntax-import"><span class="std std-ref">import</span></a> list of the module,
a list of initialization <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a> for the module’s <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">globals</span></a>,
and list of <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">reference</span></a> lists for the module’s <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segments</span></a>.</p>
<ol class="arabic simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> be the <a class="reference internal" href="../syntax/modules.html#syntax-module"><span class="std std-ref">module</span></a> to allocate and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_{\mathrm{im}}^\ast\)</span> the list of <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external values</span></a> providing the module’s imports, <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}}^\ast\)</span> the initialization <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a> of the module’s <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">globals</span></a>, <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}}^\ast\)</span> the initializer <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">reference</span></a> of the module’s <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">tables</span></a>, and <span class="math notranslate nohighlight">\((\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{e}}^\ast)^\ast\)</span> the <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">reference</span></a> lists of the module’s <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segments</span></a>.</p></li>
<li><p>For each <a class="reference internal" href="../valid/conventions.html#syntax-deftype"><span class="std std-ref">defined type</span></a> <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{types}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}_i\)</span> be the <a class="reference internal" href="types.html#type-inst"><span class="std std-ref">instantiation</span></a> <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'_i\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-func"><span class="std std-ref">function</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-func}{\mathit{func}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{funcs}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-funcaddr"><span class="std std-ref">function address</span></a> resulting from <a class="reference internal" href="#alloc-func"><span class="std std-ref">allocating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-func}{\mathit{func}}_i\)</span> for the <a class="reference internal" href="runtime.html#syntax-moduleinst"><span class="std std-ref">module instance</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">table</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-table}{\mathit{table}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{tables}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-limits}{\mathit{limits}}_i~t_i\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-tabletype"><span class="std std-ref">table type</span></a> obtained by <a class="reference internal" href="types.html#type-inst"><span class="std std-ref">instantiating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-table}{\mathit{table}}_i.\href{../syntax/modules.html#syntax-table}{\mathsf{type}}\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-tableaddr"><span class="std std-ref">table address</span></a> resulting from <a class="reference internal" href="#alloc-table"><span class="std std-ref">allocating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-table}{\mathit{table}}_i.\href{../syntax/modules.html#syntax-table}{\mathsf{type}}\)</span> with initialization value <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}}^\ast[i]\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-mem"><span class="std std-ref">memory</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{mems}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}_i\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-memtype"><span class="std std-ref">memory type</span></a> obtained by <a class="reference internal" href="types.html#type-inst"><span class="std std-ref">insantiating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}_i.\href{../syntax/modules.html#syntax-mem}{\mathsf{type}}\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-memaddr"><span class="std std-ref">memory address</span></a> resulting from <a class="reference internal" href="#alloc-mem"><span class="std std-ref">allocating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}_i\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">global</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-global}{\mathit{global}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{globals}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}_i\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-globaltype"><span class="std std-ref">global type</span></a> obtained by <a class="reference internal" href="types.html#type-inst"><span class="std std-ref">instantiating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-global}{\mathit{global}}_i.\href{../syntax/modules.html#syntax-global}{\mathsf{type}}\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-globaladdr"><span class="std std-ref">global address</span></a> resulting from <a class="reference internal" href="#alloc-global"><span class="std std-ref">allocating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}_i\)</span> with initializer value <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}}^\ast[i]\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{elems}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}}_i\)</span> be the element <a class="reference internal" href="../syntax/types.html#syntax-reftype"><span class="std std-ref">reference type</span></a> obtained by <cite>instantiating &lt;type-inst&gt;</cite> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i.\href{../syntax/modules.html#syntax-elem}{\mathsf{type}}\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-elemaddr}{\mathit{elemaddr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-elemaddr"><span class="std std-ref">element address</span></a> resulting from <a class="reference internal" href="#alloc-elem"><span class="std std-ref">allocating</span></a> a <a class="reference internal" href="runtime.html#syntax-eleminst"><span class="std std-ref">element instance</span></a> of <a class="reference internal" href="../syntax/types.html#syntax-reftype"><span class="std std-ref">reference type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}}_i\)</span> with contents <span class="math notranslate nohighlight">\((\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{e}}^\ast)^\ast[i]\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-data"><span class="std std-ref">data segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-data}{\mathit{data}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{datas}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-dataaddr}{\mathit{dataaddr}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-dataaddr"><span class="std std-ref">data address</span></a> resulting from <a class="reference internal" href="#alloc-data"><span class="std std-ref">allocating</span></a> a <a class="reference internal" href="runtime.html#syntax-datainst"><span class="std std-ref">data instance</span></a> with contents <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-data}{\mathit{data}}_i.\href{../syntax/modules.html#syntax-data}{\mathsf{init}}\)</span>.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="../valid/conventions.html#syntax-deftype"><span class="std std-ref">defined types</span></a> <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-funcaddr"><span class="std std-ref">function addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-tableaddr"><span class="std std-ref">table addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-memaddr"><span class="std std-ref">memory addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-globaladdr"><span class="std std-ref">global addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-elemaddr}{\mathit{elemaddr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-elemaddr"><span class="std std-ref">element addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-elemaddr}{\mathit{elemaddr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-dataaddr}{\mathit{dataaddr}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-dataaddr"><span class="std std-ref">data addresses</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-dataaddr}{\mathit{dataaddr}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}_{\mathrm{mod}}^\ast\)</span> be the list of <a class="reference internal" href="runtime.html#syntax-funcaddr"><span class="std std-ref">function addresses</span></a> extracted from <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_{\mathrm{im}}^\ast\)</span>, concatenated with <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}^\ast\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}_{\mathrm{mod}}^\ast\)</span> be the list of <a class="reference internal" href="runtime.html#syntax-tableaddr"><span class="std std-ref">table addresses</span></a> extracted from <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_{\mathrm{im}}^\ast\)</span>, concatenated with <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}^\ast\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}_{\mathrm{mod}}^\ast\)</span> be the list of <a class="reference internal" href="runtime.html#syntax-memaddr"><span class="std std-ref">memory addresses</span></a> extracted from <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_{\mathrm{im}}^\ast\)</span>, concatenated with <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}^\ast\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}_{\mathrm{mod}}^\ast\)</span> be the list of <a class="reference internal" href="runtime.html#syntax-globaladdr"><span class="std std-ref">global addresses</span></a> extracted from <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_{\mathrm{im}}^\ast\)</span>, concatenated with <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}^\ast\)</span>.</p></li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-export"><span class="std std-ref">export</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{exports}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>If <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i\)</span> is a function export for <a class="reference internal" href="../syntax/modules.html#syntax-funcidx"><span class="std std-ref">function index</span></a> <span class="math notranslate nohighlight">\(x\)</span>, then let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external value</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathsf{func}}~(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}_{\mathrm{mod}}^\ast[x])\)</span>.</p></li>
<li><p>Else, if <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i\)</span> is a table export for <a class="reference internal" href="../syntax/modules.html#syntax-tableidx"><span class="std std-ref">table index</span></a> <span class="math notranslate nohighlight">\(x\)</span>, then let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external value</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathsf{table}}~(\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}_{\mathrm{mod}}^\ast[x])\)</span>.</p></li>
<li><p>Else, if <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i\)</span> is a memory export for <a class="reference internal" href="../syntax/modules.html#syntax-memidx"><span class="std std-ref">memory index</span></a> <span class="math notranslate nohighlight">\(x\)</span>, then let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external value</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathsf{mem}}~(\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}_{\mathrm{mod}}^\ast[x])\)</span>.</p></li>
<li><p>Else, if <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i\)</span> is a global export for <a class="reference internal" href="../syntax/modules.html#syntax-globalidx"><span class="std std-ref">global index</span></a> <span class="math notranslate nohighlight">\(x\)</span>, then let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external value</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathsf{global}}~(\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}_{\mathrm{mod}}^\ast[x])\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-exportinst}{\mathit{exportinst}}_i\)</span> be the <a class="reference internal" href="runtime.html#syntax-exportinst"><span class="std std-ref">export instance</span></a> <span class="math notranslate nohighlight">\(\{\href{../exec/runtime.html#syntax-exportinst}{\mathsf{name}}~(\href{../syntax/modules.html#syntax-export}{\mathit{export}}_i.\href{../syntax/modules.html#syntax-export}{\mathsf{name}}), \href{../exec/runtime.html#syntax-exportinst}{\mathsf{value}}~\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\}\)</span>.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-exportinst}{\mathit{exportinst}}^\ast\)</span> be the concatenation of the <a class="reference internal" href="runtime.html#syntax-exportinst"><span class="std std-ref">export instances</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-exportinst}{\mathit{exportinst}}_i\)</span> in index order.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-moduleinst"><span class="std std-ref">module instance</span></a> <span class="math notranslate nohighlight">\(\{\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{types}}~\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}^\ast,\)</span> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{funcs}}~\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}_{\mathrm{mod}}^\ast,\)</span> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{tables}}~\href{../exec/runtime.html#syntax-tableaddr}{\mathit{tableaddr}}_{\mathrm{mod}}^\ast,\)</span> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{mems}}~\href{../exec/runtime.html#syntax-memaddr}{\mathit{memaddr}}_{\mathrm{mod}}^\ast,\)</span> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{globals}}~\href{../exec/runtime.html#syntax-globaladdr}{\mathit{globaladdr}}_{\mathrm{mod}}^\ast,\)</span> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{exports}}~\href{../exec/runtime.html#syntax-exportinst}{\mathit{exportinst}}^\ast\}\)</span>.</p></li>
<li><p>Return <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#alloc-module}{\mathrm{allocmodule}}}(s, {\href{../syntax/modules.html#syntax-module}{\mathit{module}}}, {{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast}, {{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{g}}^\ast}, {{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{t}}^\ast}, {({{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{e}}^\ast})^\ast}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ (s_6, {\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../syntax/modules.html#syntax-module}{\mathit{module}}} = \href{../syntax/modules.html#syntax-module}{\mathsf{module}}~{{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}}^\ast}~{{\href{../syntax/modules.html#syntax-import}{\mathit{import}}}^\ast}~{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast}~{{\href{../syntax/modules.html#syntax-global}{\mathit{global}}}^\ast}~{{\href{../syntax/modules.html#syntax-table}{\mathit{table}}}^\ast}~{{\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}}^\ast}~{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast}~{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}~{{\href{../syntax/modules.html#syntax-start}{\mathit{start}}}^?}~{{\href{../syntax/modules.html#syntax-export}{\mathit{export}}}^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast} = {(\href{../syntax/modules.html#syntax-func}{\mathsf{func}}~x~{{\href{../syntax/modules.html#syntax-local}{\mathit{local}}}^\ast}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{f}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-global}{\mathit{global}}}^\ast} = {(\href{../syntax/modules.html#syntax-global}{\mathsf{global}}~{\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{g}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-table}{\mathit{table}}}^\ast} = {(\href{../syntax/modules.html#syntax-table}{\mathsf{table}}~{\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{t}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}}^\ast} = {(\href{../syntax/modules.html#syntax-mem}{\mathsf{memory}}~{\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast} = {(\href{../syntax/modules.html#syntax-elem}{\mathsf{elem}}~{\href{../syntax/types.html#syntax-elemtype}{\mathit{elemtype}}}~{{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{e}}^\ast}~{\href{../syntax/modules.html#syntax-elemmode}{\mathit{elemmode}}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast} = {(\href{../syntax/modules.html#syntax-data}{\mathsf{data}}~{{\href{../syntax/values.html#syntax-byte}{\mathit{byte}}}^\ast}~{\href{../syntax/modules.html#syntax-datamode}{\mathit{datamode}}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{fa}}_{\mathsf{i}}^\ast} = {\href{../exec/runtime.html#syntax-externval}{\mathrm{funcs}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ga}}_{\mathsf{i}}^\ast} = {\href{../exec/runtime.html#syntax-externval}{\mathrm{globals}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ta}}_{\mathsf{i}}^\ast} = {\href{../exec/runtime.html#syntax-externval}{\mathrm{tables}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ma}}_{\mathsf{i}}^\ast} = {\href{../exec/runtime.html#syntax-externval}{\mathrm{mems}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{fa}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}|} + i_{\mathsf{f}})^{i_{\mathsf{f}}&lt;{|{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ga}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{globals}}|} + i_{\mathsf{g}})^{i_{\mathsf{g}}&lt;{|{{\href{../syntax/modules.html#syntax-global}{\mathit{global}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ta}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{tables}}|} + i_{\mathsf{t}})^{i_{\mathsf{t}}&lt;{|{{\href{../syntax/modules.html#syntax-table}{\mathit{table}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ma}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{mems}}|} + i_{\mathsf{m}})^{i_{\mathsf{m}}&lt;{|{{\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{ea}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{elems}}|} + i_{\mathsf{e}})^{i_{\mathsf{e}}&lt;{|{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{da}}^\ast} = {({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{datas}}|} + i_{\mathsf{d}})^{i_{\mathsf{d}}&lt;{|{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{dt}}^\ast} = {{{\href{../exec/modules.html#alloc-type}{\mathrm{alloctype}}}^\ast}}{({{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}}^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_1, {{\mathit{fa}}^\ast}) = {{{\href{../exec/modules.html#alloc-func}{\mathrm{allocfunc}}}^\ast}}{(s, {{{\mathit{dt}}^\ast}{}[x]^\ast}, {(\href{../syntax/modules.html#syntax-func}{\mathsf{func}}~x~{{\href{../syntax/modules.html#syntax-local}{\mathit{local}}}^\ast}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{f}})^\ast}, {{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}^{{|{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast}|}}})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_2, {{\mathit{ga}}^\ast}) = {{{\href{../exec/modules.html#alloc-global}{\mathrm{allocglobal}}}^\ast}}{(s_1, {{\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}}^\ast}, {{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{g}}^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_3, {{\mathit{ta}}^\ast}) = {{{\href{../exec/modules.html#alloc-table}{\mathrm{alloctable}}}^\ast}}{(s_2, {{\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}}^\ast}, {{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{t}}^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_4, {{\mathit{ma}}^\ast}) = {{{\href{../exec/modules.html#alloc-mem}{\mathrm{allocmem}}}^\ast}}{(s_3, {{\href{../syntax/types.html#syntax-memtype}{\mathit{memtype}}}^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_5, {{\mathit{ea}}^\ast}) = {{{\href{../exec/modules.html#alloc-elem}{\mathrm{allocelem}}}^\ast}}{(s_4, {{\href{../syntax/types.html#syntax-elemtype}{\mathit{elemtype}}}^\ast}, {({{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{e}}^\ast})^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s_6, {{\mathit{da}}^\ast}) = {{{\href{../exec/modules.html#alloc-data}{\mathrm{allocdata}}}^\ast}}{(s_5, {\href{../valid/modules.html#valid-data}{\mathsf{ok}}^{{|{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}|}}}, {({{\href{../syntax/values.html#syntax-byte}{\mathit{byte}}}^\ast})^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\mathit{xi}}^\ast} = {{{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}^\ast}}{(\{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{funcs}}~{{\mathit{fa}}_{\mathsf{i}}^\ast}~{{\mathit{fa}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{globals}}~{{\mathit{ga}}_{\mathsf{i}}^\ast}~{{\mathit{ga}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{tables}}~{{\mathit{ta}}_{\mathsf{i}}^\ast}~{{\mathit{ta}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{mems}}~{{\mathit{ma}}_{\mathsf{i}}^\ast}~{{\mathit{ma}}^\ast} \}\end{array}, {{\href{../syntax/modules.html#syntax-export}{\mathit{export}}}^\ast})}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}} = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{types}}~{{\mathit{dt}}^\ast},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{funcs}}~{{\mathit{fa}}_{\mathsf{i}}^\ast}~{{\mathit{fa}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{globals}}~{{\mathit{ga}}_{\mathsf{i}}^\ast}~{{\mathit{ga}}^\ast},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{tables}}~{{\mathit{ta}}_{\mathsf{i}}^\ast}~{{\mathit{ta}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{mems}}~{{\mathit{ma}}_{\mathsf{i}}^\ast}~{{\mathit{ma}}^\ast},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{elems}}~{{\mathit{ea}}^\ast},\; \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{datas}}~{{\mathit{da}}^\ast},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{exports}}~{{\mathit{xi}}^\ast} \}\end{array}} \\
\end{array}\end{split}\]</div>
<p>Here, the notation <span class="math notranslate nohighlight">\(\mathrm{allocx}^\ast\)</span> is shorthand for multiple <a class="reference internal" href="#alloc"><span class="std std-ref">allocations</span></a> of object kind <span class="math notranslate nohighlight">\(X\)</span>, defined as follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{{{\mathrm{allocX}}^\ast}}{(s, \epsilon, \epsilon)} &amp;=&amp; (s, \epsilon) \\
{{{\mathrm{allocX}}^\ast}}{(s, X~{{X'}^\ast}, Y~{{Y'}^\ast})} &amp;=&amp; (s_2, a~{{a'}^\ast})
  &amp;\qquad \mbox{if}~(s_1, a) = {\mathrm{allocX}}(X, Y, s, X, Y) \\
  &amp;&amp;&amp;\qquad {\land}~(s_2, {{a'}^\ast}) = {{{\mathrm{allocX}}^\ast}}{(s_1, {{X'}^\ast}, {{Y'}^\ast})} \\
\end{array}\end{split}\]</div>
<p>For types, however, allocation is defined in terms of <a class="reference internal" href="../valid/conventions.html#aux-roll-rectype"><span class="std std-ref">rolling</span></a> and <a class="reference internal" href="../valid/conventions.html#notation-subst"><span class="std std-ref">substitution</span></a> of all preceding types to produce a list of <a class="reference internal" href="../valid/conventions.html#type-closed"><span class="std std-ref">closed</span></a> <a class="reference internal" href="../valid/conventions.html#syntax-deftype"><span class="std std-ref">defined types</span></a>:</p>
<div class="math notranslate nohighlight" id="alloc-type">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{{{\href{../exec/modules.html#alloc-type}{\mathrm{alloctype}}}^\ast}}{(\epsilon)} &amp;=&amp; \epsilon \\
{{{\href{../exec/modules.html#alloc-type}{\mathrm{alloctype}}}^\ast}}{({{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}'}^\ast}~{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}})} &amp;=&amp; {{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'}^\ast}~{{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}}^\ast}
  &amp;\qquad \mbox{if}~{{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'}^\ast} = {{{\href{../exec/modules.html#alloc-type}{\mathrm{alloctype}}}^\ast}}{({{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}'}^\ast})} \\
  &amp;&amp;&amp;\qquad {\land}~{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}} = \href{../syntax/modules.html#syntax-type}{\mathsf{type}}~{\href{../syntax/types.html#syntax-rectype}{\mathit{rectype}}} \\
  &amp;&amp;&amp;\qquad {\land}~{{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}}^\ast} = {{{{{\href{../valid/conventions.html#aux-roll-deftype}{\mathrm{roll}}}}_{x}^\ast}}{({\href{../syntax/types.html#syntax-rectype}{\mathit{rectype}}})}}{{}[ {\href{../valid/conventions.html#notation-subst}{\mathrel{:=}}}\, {{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'}^\ast} ]} \\
  &amp;&amp;&amp;\qquad {\land}~x = {|{{\href{../valid/conventions.html#syntax-deftype}{\mathit{deftype}}'}^\ast}|} \\
\end{array}\end{split}\]</div>
<p>Finally, export instances are produced with the help of the following definition:</p>
<div class="math notranslate nohighlight" id="alloc-export">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{{{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}^\ast}}{({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, {{\href{../syntax/modules.html#syntax-export}{\mathit{export}}}^\ast})} &amp;=&amp; {{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, {\href{../syntax/modules.html#syntax-export}{\mathit{export}}})^\ast} \\
{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, \href{../syntax/modules.html#syntax-export}{\mathsf{export}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}}~(\href{../syntax/modules.html#syntax-externidx}{\mathsf{func}}~x)) &amp;=&amp; \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-exportinst}{\mathsf{name}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}},\; \href{../exec/runtime.html#syntax-exportinst}{\mathsf{value}}~(\href{../exec/runtime.html#syntax-externval}{\mathsf{func}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}{.}\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{funcs}}{}[x]) \}\end{array} \\
{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, \href{../syntax/modules.html#syntax-export}{\mathsf{export}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}}~(\href{../syntax/modules.html#syntax-externidx}{\mathsf{global}}~x)) &amp;=&amp; \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-exportinst}{\mathsf{name}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}},\; \href{../exec/runtime.html#syntax-exportinst}{\mathsf{value}}~(\href{../exec/runtime.html#syntax-externval}{\mathsf{global}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}{.}\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{globals}}{}[x]) \}\end{array} \\
{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, \href{../syntax/modules.html#syntax-export}{\mathsf{export}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}}~(\href{../syntax/modules.html#syntax-externidx}{\mathsf{table}}~x)) &amp;=&amp; \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-exportinst}{\mathsf{name}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}},\; \href{../exec/runtime.html#syntax-exportinst}{\mathsf{value}}~(\href{../exec/runtime.html#syntax-externval}{\mathsf{table}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}{.}\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{tables}}{}[x]) \}\end{array} \\
{\href{../exec/modules.html#alloc-export}{\mathrm{allocexport}}}({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}, \href{../syntax/modules.html#syntax-export}{\mathsf{export}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}}~(\href{../syntax/modules.html#syntax-externidx}{\mathsf{memory}}~x)) &amp;=&amp; \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-exportinst}{\mathsf{name}}~{\href{../syntax/values.html#syntax-name}{\mathit{name}}},\; \href{../exec/runtime.html#syntax-exportinst}{\mathsf{value}}~(\href{../exec/runtime.html#syntax-externval}{\mathsf{mem}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}{.}\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{mems}}{}[x]) \}\end{array} \\
\end{array}\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The definition of module allocation is mutually recursive with the allocation of its associated functions, because the resulting module instance is passed to the allocators as an argument, in order to form the necessary closures.
In an implementation, this recursion is easily unraveled by mutating one or the other in a secondary step.</p>
</div>
</section>
</section>
<section id="instantiation">
<span id="exec-instantiation"></span><span id="exec-module"></span><span id="index-10"></span><h2>Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this heading">¶</a></h2>
<p>Given a <a class="reference internal" href="runtime.html#syntax-store"><span class="std std-ref">store</span></a> <span class="math notranslate nohighlight">\(s\)</span>, a <span class="math notranslate nohighlight">\({\href{../syntax/modules.html#syntax-module}{\mathit{module}}}\)</span> is instantiated with a list of <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external values</span></a> <span class="math notranslate nohighlight">\({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast}\)</span> supplying the required imports as follows.</p>
<p>Instantiation checks that the module is <a class="reference internal" href="../valid/index.html#valid"><span class="std std-ref">valid</span></a> and the provided imports <a class="reference internal" href="../valid/matching.html#match-externtype"><span class="std std-ref">match</span></a> the declared types,
and may <em>fail</em> with an error otherwise.
Instantiation can also result in a <a class="reference internal" href="../intro/overview.html#trap"><span class="std std-ref">trap</span></a> from initializing a table or memory from an active segment or from executing the start function.
It is up to the <a class="reference internal" href="../intro/overview.html#embedder"><span class="std std-ref">embedder</span></a> to define how such conditions are reported.</p>
<ol class="arabic simple">
<li><p>If <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> is not <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">valid</span></a>, then:</p>
<ol class="loweralpha simple">
<li><p>Fail.</p></li>
</ol>
</li>
<li><p>Assert: <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> is <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">valid</span></a> with <a class="reference internal" href="../syntax/types.html#syntax-externtype"><span class="std std-ref">external types</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}_{\mathrm{im}}^m\)</span> classifying its <a class="reference internal" href="../syntax/modules.html#syntax-import"><span class="std std-ref">imports</span></a>.</p></li>
<li><p>If the number <span class="math notranslate nohighlight">\(m\)</span> of <a class="reference internal" href="../syntax/modules.html#syntax-import"><span class="std std-ref">imports</span></a> is not equal to the number <span class="math notranslate nohighlight">\(n\)</span> of provided <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external values</span></a>, then:</p>
<ol class="loweralpha simple">
<li><p>Fail.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="runtime.html#syntax-externval"><span class="std std-ref">external value</span></a> <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}^n\)</span> and <a class="reference internal" href="../syntax/types.html#syntax-externtype"><span class="std std-ref">external type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}'_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}_{\mathrm{im}}^n\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>If <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}_i\)</span> is not <a class="reference internal" href="values.html#valid-externval"><span class="std std-ref">valid</span></a> with an <a class="reference internal" href="../syntax/types.html#syntax-externtype"><span class="std std-ref">external type</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}_i\)</span> in store <span class="math notranslate nohighlight">\(S\)</span>, then:</p>
<ol class="lowerroman simple">
<li><p>Fail.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}''_i\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-externtype"><span class="std std-ref">external type</span></a> obtained by <a class="reference internal" href="types.html#type-inst"><span class="std std-ref">instantiating</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}'_i\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> defined below.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}_i\)</span> does not <a class="reference internal" href="../valid/matching.html#match-externtype"><span class="std std-ref">match</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-externtype}{\mathit{externtype}}''_i\)</span>, then:</p>
<ol class="lowerroman simple">
<li><p>Fail.</p></li>
</ol>
</li>
</ol>
</li>
</ol>
<ol class="arabic simple" id="exec-initvals" start="6">
<li><p>Let <span class="math notranslate nohighlight">\(F\)</span> be the auxiliary <a class="reference internal" href="runtime.html#syntax-frame"><span class="std std-ref">frame</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-frame}{\mathsf{module}}~\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}, \href{../exec/runtime.html#syntax-frame}{\mathsf{locals}}~\epsilon \}\)</span>, that consists of the final module instance <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span>, defined below.</p></li>
<li><p>Push the frame <span class="math notranslate nohighlight">\(F\)</span> to the stack.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}}^\ast\)</span> be the list of <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">global</span></a> initialization <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a> determined by <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}^n\)</span>. These may be calculated as follows.</p>
<ol class="loweralpha simple">
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">global</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-global}{\mathit{global}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{globals}}\)</span>, do:</p>
<ol class="lowerroman simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}i}\)</span> be the result of <a class="reference internal" href="instructions.html#exec-expr"><span class="std std-ref">evaluating</span></a> the initializer expression <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-global}{\mathit{global}}_i.\href{../syntax/modules.html#syntax-global}{\mathsf{init}}\)</span>.</p></li>
</ol>
</li>
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">validation</span></a>, the frame <span class="math notranslate nohighlight">\(F\)</span> is now on the top of the stack.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}}^\ast\)</span> be the concatenation of <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}i}\)</span> in index order.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}}^\ast\)</span> be the list of <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">table</span></a> initialization <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">references</span></a> determined by <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> and <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}^n\)</span>. These may be calculated as follows.</p>
<ol class="loweralpha simple">
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">table</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-table}{\mathit{table}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{tables}}\)</span>, do:</p>
<ol class="lowerroman simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{t}i}\)</span> be the result of <a class="reference internal" href="instructions.html#exec-expr"><span class="std std-ref">evaluating</span></a> the initializer expression <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-table}{\mathit{table}}_i.\href{../syntax/modules.html#syntax-table}{\mathsf{init}}\)</span>.</p></li>
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-table"><span class="std std-ref">validation</span></a>, <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{t}i}\)</span> is a <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">reference</span></a>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}i}\)</span> be the reference <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{t}i}\)</span>.</p></li>
</ol>
</li>
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">validation</span></a>, the frame <span class="math notranslate nohighlight">\(F\)</span> is now on the top of the stack.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}}^\ast\)</span> be the concatenation of <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{ti}\)</span> in index order.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\((\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{e}}^\ast)^\ast\)</span> be the list of <a class="reference internal" href="runtime.html#syntax-ref"><span class="std std-ref">reference</span></a> lists determined by the <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segments</span></a> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span>. These may be calculated as follows.</p>
<ol class="loweralpha simple">
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{elems}}\)</span>, and for each element <a class="reference internal" href="../syntax/instructions.html#syntax-expr"><span class="std std-ref">expression</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}_{ij}\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i.\href{../syntax/modules.html#syntax-elem}{\mathsf{init}}\)</span>, do:</p>
<ol class="lowerroman simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{ij}\)</span> be the result of <a class="reference internal" href="instructions.html#exec-expr"><span class="std std-ref">evaluating</span></a> the initializer expression <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}_{ij}\)</span>.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^\ast_i\)</span> be the concatenation of function elements <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{ij}\)</span> in order of index <span class="math notranslate nohighlight">\(j\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\((\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{e}}^\ast)^\ast\)</span> be the concatenation of function element lists <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}^\ast_i\)</span> in order of index <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}\)</span> be a new module instance <a class="reference internal" href="#alloc-module"><span class="std std-ref">allocated</span></a> from <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}\)</span> in store <span class="math notranslate nohighlight">\(S\)</span> with imports <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}^n\)</span>, global initializer values <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{g}}^\ast\)</span>, table initializer values <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{t}}^\ast\)</span>, and element segment contents <span class="math notranslate nohighlight">\((\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}_{\mathrm{e}}^\ast)^\ast\)</span>, and let <span class="math notranslate nohighlight">\(S'\)</span> be the extended store produced by module allocation.</p></li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{elems}}\)</span> whose <a class="reference internal" href="../syntax/modules.html#syntax-elemmode"><span class="std std-ref">mode</span></a> is of the form <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elemmode}{\mathsf{active}}~\{ \href{../syntax/modules.html#syntax-elem}{\mathsf{table}}~\href{../syntax/modules.html#syntax-tableidx}{\mathit{tableidx}}_i, \href{../syntax/modules.html#syntax-elem}{\mathsf{offset}}~\mathit{einstr}^\ast_i~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}} \}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(n\)</span> be the length of the list <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i.\href{../syntax/modules.html#syntax-elem}{\mathsf{init}}\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-instrs"><span class="std std-ref">Execute</span></a> the instruction sequence <span class="math notranslate nohighlight">\(\mathit{einstr}^\ast_i\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-const"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}.\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~0\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-const"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}.\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~n\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-table-init"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{table{.}init}}~\href{../syntax/modules.html#syntax-tableidx}{\mathit{tableidx}}_i~i\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-elem-drop"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{elem{.}drop}}~i\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{elems}}\)</span> whose <a class="reference internal" href="../syntax/modules.html#syntax-elemmode"><span class="std std-ref">mode</span></a> is of the form <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-elemmode}{\mathsf{declare}}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p><a class="reference internal" href="instructions.html#exec-elem-drop"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{elem{.}drop}}~i\)</span>.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/modules.html#syntax-data"><span class="std std-ref">data segment</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-data}{\mathit{data}}_i\)</span> in <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{datas}}\)</span> whose <a class="reference internal" href="../syntax/modules.html#syntax-datamode"><span class="std std-ref">mode</span></a> is of the form <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-datamode}{\mathsf{active}}~\{ \href{../syntax/modules.html#syntax-data}{\mathsf{memory}}~\href{../syntax/modules.html#syntax-memidx}{\mathit{memidx}}_i, \href{../syntax/modules.html#syntax-data}{\mathsf{offset}}~\mathit{dinstr}^\ast_i~\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{end}} \}\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>Assert: <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-memidx}{\mathit{memidx}}_i\)</span> is <span class="math notranslate nohighlight">\(0\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(n\)</span> be the length of the list <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-data}{\mathit{data}}_i.\href{../syntax/modules.html#syntax-data}{\mathsf{init}}\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-instrs"><span class="std std-ref">Execute</span></a> the instruction sequence <span class="math notranslate nohighlight">\(\mathit{dinstr}^\ast_i\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-const"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}.\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~0\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-const"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}.\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~n\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-memory-init"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-memory}{\mathsf{memory{.}init}}~i\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-data-drop"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-memory}{\mathsf{data{.}drop}}~i\)</span>.</p></li>
</ol>
</li>
<li><p>If the <a class="reference internal" href="../syntax/modules.html#syntax-start"><span class="std std-ref">start function</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{start}}\)</span> is not empty, then:</p>
<ol class="loweralpha simple">
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-start}{\mathit{start}}\)</span> be the <a class="reference internal" href="../syntax/modules.html#syntax-start"><span class="std std-ref">start function</span></a> <span class="math notranslate nohighlight">\(\href{../syntax/modules.html#syntax-module}{\mathit{module}}.\href{../syntax/modules.html#syntax-module}{\mathsf{start}}\)</span>.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-call"><span class="std std-ref">Execute</span></a> the instruction <span class="math notranslate nohighlight">\(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{call}}~\href{../syntax/modules.html#syntax-start}{\mathit{start}}.\href{../syntax/modules.html#syntax-start}{\mathsf{func}}\)</span>.</p></li>
</ol>
</li>
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">validation</span></a>, the frame <span class="math notranslate nohighlight">\(F\)</span> is now on the top of the stack.</p></li>
<li><p>Pop the frame <span class="math notranslate nohighlight">\(F\)</span> from the stack.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#exec-instantiation}{\mathrm{instantiate}}}(s, {\href{../syntax/modules.html#syntax-module}{\mathit{module}}}, {{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ {s'} ; f ; {{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{e}}^\ast}~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{d}}^\ast}~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{s}}^?} } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~{\href{../valid/modules.html#valid-module}{\vdash}}\, {\href{../syntax/modules.html#syntax-module}{\mathit{module}}} : {{\mathit{xt}}_{\mathsf{i}}^\ast} \mathrel{\href{../valid/modules.html#syntax-moduletype}{\rightarrow}} {{\mathit{xt}}_{\mathsf{e}}^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s \vdash {\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}} : {\mathit{xt}}_{\mathsf{i}})^\ast} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{\href{../syntax/modules.html#syntax-module}{\mathit{module}}} = \href{../syntax/modules.html#syntax-module}{\mathsf{module}}~{{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}}^\ast}~{{\href{../syntax/modules.html#syntax-import}{\mathit{import}}}^\ast}~{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast}~{{\href{../syntax/modules.html#syntax-global}{\mathit{global}}}^\ast}~{{\href{../syntax/modules.html#syntax-table}{\mathit{table}}}^\ast}~{{\href{../syntax/modules.html#syntax-mem}{\mathit{mem}}}^\ast}~{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast}~{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}~{{\href{../syntax/modules.html#syntax-start}{\mathit{start}}}^?}~{{\href{../syntax/modules.html#syntax-export}{\mathit{export}}}^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-global}{\mathit{global}}}^\ast} = {(\href{../syntax/modules.html#syntax-global}{\mathsf{global}}~{\href{../syntax/types.html#syntax-globaltype}{\mathit{globaltype}}}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{g}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-table}{\mathit{table}}}^\ast} = {(\href{../syntax/modules.html#syntax-table}{\mathsf{table}}~{\href{../syntax/types.html#syntax-tabletype}{\mathit{tabletype}}}~{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{t}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast} = {(\href{../syntax/modules.html#syntax-elem}{\mathsf{elem}}~{\href{../syntax/types.html#syntax-reftype}{\mathit{reftype}}}~{{\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{e}}^\ast}~{\href{../syntax/modules.html#syntax-elemmode}{\mathit{elemmode}}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast} = {(\href{../syntax/modules.html#syntax-data}{\mathsf{data}}~{{\href{../syntax/values.html#syntax-byte}{\mathit{byte}}}^\ast}~{\href{../syntax/modules.html#syntax-datamode}{\mathit{datamode}}})^\ast}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/modules.html#syntax-start}{\mathit{start}}}^?} = {(\href{../syntax/modules.html#syntax-start}{\mathsf{start}}~x)^?}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}_0 = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-moduleinst}{\mathsf{types}}~{{{\href{../exec/modules.html#alloc-type}{\mathrm{alloctype}}}^\ast}}{({{\href{../syntax/types.html#syntax-rectype}{\mathit{type}}}^\ast})},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{funcs}}~{\href{../exec/runtime.html#syntax-externval}{\mathrm{funcs}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast})~{({|s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}|} + i_{\mathsf{f}})^{i_{\mathsf{f}}&lt;{|{{\href{../syntax/modules.html#syntax-func}{\mathit{func}}}^\ast}|}}},\; \\
  \href{../exec/runtime.html#syntax-moduleinst}{\mathsf{globals}}~{\href{../exec/runtime.html#syntax-externval}{\mathrm{globals}}}({{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast}) \}\end{array}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~z = s ; \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-frame}{\mathsf{module}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}_0 \}\end{array}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(z ; {\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{g}} \href{../exec/conventions.html#exec-notation}{\hookrightarrow^\ast} z ; {\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{g}})^\ast} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(z ; {\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{t}} \href{../exec/conventions.html#exec-notation}{\hookrightarrow^\ast} z ; {\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{t}})^\ast} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{(z ; {\href{../syntax/instructions.html#syntax-expr}{\mathit{expr}}}_{\mathsf{e}} \href{../exec/conventions.html#exec-notation}{\hookrightarrow^\ast} z ; {\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{e}})^\ast}^\ast} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~({s'}, {\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}) = {\href{../exec/modules.html#alloc-module}{\mathrm{allocmodule}}}(s, {\href{../syntax/modules.html#syntax-module}{\mathit{module}}}, {{\href{../exec/runtime.html#syntax-externval}{\mathit{externval}}}^\ast}, {{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{g}}^\ast}, {{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{t}}^\ast}, {({{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{e}}^\ast})^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~f = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-frame}{\mathsf{module}}~{\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}} \}\end{array}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{e}}^\ast} = {\href{../syntax/conventions.html#notation-concat}{\bigoplus}}\, {{{\href{../exec/modules.html#aux-runelem}{\mathrm{runelem}}}}_{i_{\mathsf{e}}}({{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast}{}[i_{\mathsf{e}}])^{i_{\mathsf{e}}&lt;{|{{\href{../syntax/modules.html#syntax-elem}{\mathit{elem}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{d}}^\ast} = {\href{../syntax/conventions.html#notation-concat}{\bigoplus}}\, {{{\href{../exec/modules.html#aux-rundata}{\mathrm{rundata}}}}_{i_{\mathsf{d}}}({{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}{}[i_{\mathsf{d}}])^{i_{\mathsf{d}}&lt;{|{{\href{../syntax/modules.html#syntax-data}{\mathit{data}}}^\ast}|}}}} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}_{\mathsf{s}}^?} = {(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{call}}~x)^?}} \\
\end{array}\end{split}\]</div>
<p>where:</p>
<div class="math notranslate nohighlight" id="aux-rundata">
<span id="aux-runelem"></span>\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{{\href{../exec/modules.html#aux-runelem}{\mathrm{runelem}}}}_{x}(\href{../syntax/modules.html#syntax-elem}{\mathsf{elem}}~{\mathit{rt}}~{e^{n}}~(\href{../syntax/modules.html#syntax-elemmode}{\mathsf{passive}})) &amp;=&amp; \epsilon \\
{{\href{../exec/modules.html#aux-runelem}{\mathrm{runelem}}}}_{x}(\href{../syntax/modules.html#syntax-elem}{\mathsf{elem}}~{\mathit{rt}}~{e^{n}}~(\href{../syntax/modules.html#syntax-elemmode}{\mathsf{declare}})) &amp;=&amp; (\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{elem{.}drop}}~x) \\
{{\href{../exec/modules.html#aux-runelem}{\mathrm{runelem}}}}_{x}(\href{../syntax/modules.html#syntax-elem}{\mathsf{elem}}~{\mathit{rt}}~{e^{n}}~(\href{../syntax/modules.html#syntax-elemmode}{\mathsf{active}}~y~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}^\ast})) &amp;=&amp; {{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}^\ast}~(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}{.}\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~0)~(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}{.}\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~n)~(\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{table{.}init}}~y~x)~(\href{../syntax/instructions.html#syntax-instr-table}{\mathsf{elem{.}drop}}~x) \\[0.8ex]
{{\href{../exec/modules.html#aux-rundata}{\mathrm{rundata}}}}_{x}(\href{../syntax/modules.html#syntax-data}{\mathsf{data}}~{b^{n}}~(\href{../syntax/modules.html#syntax-datamode}{\mathsf{passive}})) &amp;=&amp; \epsilon \\
{{\href{../exec/modules.html#aux-rundata}{\mathrm{rundata}}}}_{x}(\href{../syntax/modules.html#syntax-data}{\mathsf{data}}~{b^{n}}~(\href{../syntax/modules.html#syntax-datamode}{\mathsf{active}}~y~{{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}^\ast})) &amp;=&amp; {{\href{../syntax/instructions.html#syntax-instr}{\mathit{instr}}}^\ast}~(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}{.}\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~0)~(\href{../syntax/types.html#syntax-numtype}{\mathsf{i\scriptstyle32}}{.}\href{../syntax/instructions.html#syntax-instr-numeric}{\mathsf{const}}~n)~(\href{../syntax/instructions.html#syntax-instr-memory}{\mathsf{memory{.}init}}~y~x)~(\href{../syntax/instructions.html#syntax-instr-memory}{\mathsf{data{.}drop}}~x) \\
\end{array}\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Checking import types assumes that the <a class="reference internal" href="runtime.html#syntax-moduleinst"><span class="std std-ref">module instance</span></a> has already been <a class="reference internal" href="#alloc-module"><span class="std std-ref">allocated</span></a> to compute the respective <a class="reference internal" href="../valid/conventions.html#type-closed"><span class="std std-ref">closed</span></a> <a class="reference internal" href="../valid/conventions.html#syntax-deftype"><span class="std std-ref">defined types</span></a>.
However, this forward reference merely is a way to simplify the specification.
In practice, implementations will likely allocate or canonicalize types beforehand, when <em>compiling</em> a module, in a stage before instantiation and before imports are checked.</p>
<p>Similarly, module <a class="reference internal" href="#alloc-module"><span class="std std-ref">allocation</span></a> and the <a class="reference internal" href="instructions.html#exec-expr"><span class="std std-ref">evaluation</span></a> of <a class="reference internal" href="../syntax/modules.html#syntax-global"><span class="std std-ref">global</span></a> and <a class="reference internal" href="../syntax/modules.html#syntax-table"><span class="std std-ref">table</span></a> initializers as well as <a class="reference internal" href="../syntax/modules.html#syntax-elem"><span class="std std-ref">element segments</span></a> are mutually recursive because the global initialization <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a> <span class="math notranslate nohighlight">\({{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{g}}^\ast}\)</span>, <span class="math notranslate nohighlight">\({\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{t}}\)</span>, and element segment contents <span class="math notranslate nohighlight">\({{{\href{../exec/runtime.html#syntax-ref}{\mathit{ref}}}_{\mathsf{e}}^\ast}^\ast}\)</span> are passed to the module allocator while depending on the module instance <span class="math notranslate nohighlight">\({\href{../exec/runtime.html#syntax-moduleinst}{\mathit{moduleinst}}}\)</span> and store <span class="math notranslate nohighlight">\({s'}\)</span> returned by allocation.
Again, this recursion is just a specification device.
In practice, the initialization values can <a class="reference internal" href="#exec-initvals"><span class="std std-ref">be determined</span></a> beforehand by staging module allocation such that first, the module’s own <a class="reference internal" href="runtime.html#syntax-funcinst"><span class="std std-ref">function instances</span></a> are pre-allocated in the store, then the initializer expressions are evaluated in order, allocating globals on the way, then the rest of the module instance is allocated, and finally the new function instances’ <span class="math notranslate nohighlight">\(\mathsf{module}\)</span> fields are set to that module instance.
This is possible because <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">validation</span></a> ensures that initialization expressions cannot actually call a function, only take their reference.</p>
<p>All failure conditions are checked before any observable mutation of the store takes place.
Store mutation is not atomic;
it happens in individual steps that may be interleaved with other threads.</p>
<p><a class="reference internal" href="instructions.html#exec-expr"><span class="std std-ref">Evaluation</span></a> of <a class="reference internal" href="../valid/instructions.html#valid-constant"><span class="std std-ref">constant expressions</span></a> does not affect the store.</p>
</div>
</section>
<section id="invocation">
<span id="exec-invocation"></span><span id="index-11"></span><h2>Invocation<a class="headerlink" href="#invocation" title="Permalink to this heading">¶</a></h2>
<p>Once a <a class="reference internal" href="../syntax/modules.html#syntax-module"><span class="std std-ref">module</span></a> has been <a class="reference internal" href="#exec-instantiation"><span class="std std-ref">instantiated</span></a>, any exported function can be <em>invoked</em> externally via its <a class="reference internal" href="runtime.html#syntax-funcaddr"><span class="std std-ref">function address</span></a> <span class="math notranslate nohighlight">\({\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}}\)</span> in the <a class="reference internal" href="runtime.html#syntax-store"><span class="std std-ref">store</span></a> <span class="math notranslate nohighlight">\(s\)</span> and an appropriate list <span class="math notranslate nohighlight">\({{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}^\ast}\)</span> of argument <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a>.</p>
<p>Invocation may <em>fail</em> with an error if the arguments do not fit the <a class="reference internal" href="../syntax/types.html#syntax-functype"><span class="std std-ref">function type</span></a>.
Invocation can also result in a <a class="reference internal" href="../intro/overview.html#trap"><span class="std std-ref">trap</span></a>.
It is up to the <a class="reference internal" href="../intro/overview.html#embedder"><span class="std std-ref">embedder</span></a> to define how such conditions are reported.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the <a class="reference internal" href="../intro/overview.html#embedder"><span class="std std-ref">embedder</span></a> API performs type checks itself, either statically or dynamically, before performing an invocation, then no failure other than traps can occur.</p>
</div>
<p>The following steps are performed:</p>
<ol class="arabic simple">
<li><p>Assert: <span class="math notranslate nohighlight">\(S.\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}[\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}]\)</span> exists.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}\)</span> be the <a class="reference internal" href="runtime.html#syntax-funcinst"><span class="std std-ref">function instance</span></a> <span class="math notranslate nohighlight">\(S.\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}[\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}]\)</span>.</p></li>
<li><p>Let <span class="math notranslate nohighlight">\(\href{../syntax/types.html#syntax-comptype}{\mathsf{func}}~[t_1^n] \href{../syntax/types.html#syntax-functype}{\rightarrow} [t_2^m]\)</span> be the <a class="reference internal" href="../syntax/types.html#syntax-comptype"><span class="std std-ref">composite type</span></a> <span class="math notranslate nohighlight">\(\href{../valid/conventions.html#aux-expand-deftype}{\mathrm{expand}}(\href{../exec/runtime.html#syntax-funcinst}{\mathit{funcinst}}.\href{../exec/runtime.html#syntax-funcinst}{\mathsf{type}})\)</span>.</p></li>
<li><p>If the length <span class="math notranslate nohighlight">\(|\href{../exec/runtime.html#syntax-val}{\mathit{val}}^\ast|\)</span> of the provided argument values is different from the number <span class="math notranslate nohighlight">\(n\)</span> of expected arguments, then:</p>
<ol class="loweralpha simple">
<li><p>Fail.</p></li>
</ol>
</li>
<li><p>For each <a class="reference internal" href="../syntax/types.html#syntax-valtype"><span class="std std-ref">value type</span></a> <span class="math notranslate nohighlight">\(t_i\)</span> in <span class="math notranslate nohighlight">\(t_1^n\)</span> and corresponding <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">value</span></a> <span class="math notranslate nohighlight">\(val_i\)</span> in <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}^\ast\)</span>, do:</p>
<ol class="loweralpha simple">
<li><p>If <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_i\)</span> is not <a class="reference internal" href="values.html#valid-val"><span class="std std-ref">valid</span></a> with value type <span class="math notranslate nohighlight">\(t_i\)</span>, then:</p>
<ol class="lowerroman simple">
<li><p>Fail.</p></li>
</ol>
</li>
</ol>
</li>
<li><p>Let <span class="math notranslate nohighlight">\(F\)</span> be the dummy <a class="reference internal" href="runtime.html#syntax-frame"><span class="std std-ref">frame</span></a> <span class="math notranslate nohighlight">\(\{ \href{../exec/runtime.html#syntax-frame}{\mathsf{module}}~\{\}, \href{../exec/runtime.html#syntax-frame}{\mathsf{locals}}~\epsilon \}\)</span>.</p></li>
<li><p>Push the frame <span class="math notranslate nohighlight">\(F\)</span> to the stack.</p></li>
<li><p>Push the values <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}^\ast\)</span> to the stack.</p></li>
<li><p><a class="reference internal" href="instructions.html#exec-invoke"><span class="std std-ref">Invoke</span></a> the function instance at address <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}\)</span>.</p></li>
</ol>
<p>Once the function has returned, the following steps are executed:</p>
<ol class="arabic simple">
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-func"><span class="std std-ref">validation</span></a>, <span class="math notranslate nohighlight">\(m\)</span> <a class="reference internal" href="runtime.html#syntax-val"><span class="std std-ref">values</span></a> are on the top of the stack.</p></li>
<li><p>Pop <span class="math notranslate nohighlight">\(\href{../exec/runtime.html#syntax-val}{\mathit{val}}_{\mathrm{res}}^m\)</span> from the stack.</p></li>
<li><p>Assert: due to <a class="reference internal" href="../valid/modules.html#valid-module"><span class="std std-ref">validation</span></a>, the frame <span class="math notranslate nohighlight">\(F\)</span> is now on the top of the stack.</p></li>
<li><p>Pop the frame <span class="math notranslate nohighlight">\(F\)</span> from the stack.</p></li>
</ol>
<p>The values <span class="math notranslate nohighlight">\({{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}_{\mathsf{res}}^{m}}\)</span> are returned as the results of the invocation.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{&#64;{}lcl&#64;{}l&#64;{}}
{\href{../exec/modules.html#exec-invocation}{\mathrm{invoke}}}(s, {\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}}, {{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}^\ast}) &amp;=&amp; \multicolumn{2}{l&#64;{}}{ s ; f ; {{\href{../exec/runtime.html#syntax-val}{\mathit{val}}}^\ast}~(\href{../exec/runtime.html#syntax-ref}{\mathsf{ref{.}func}}~{\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}})~(\href{../syntax/instructions.html#syntax-instr-control}{\mathsf{call\_ref}}~s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}{}[{\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}}]{.}\href{../exec/runtime.html#syntax-funcinst}{\mathsf{type}}) } \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad \mbox{if}~s{.}\href{../exec/runtime.html#syntax-store}{\mathsf{funcs}}{}[{\href{../exec/runtime.html#syntax-funcaddr}{\mathit{funcaddr}}}]{.}\href{../exec/runtime.html#syntax-funcinst}{\mathsf{type}} \href{../valid/conventions.html#aux-expand-deftype}{\approx} \href{../syntax/types.html#syntax-comptype}{\mathsf{func}}~({t_1^\ast} \href{../syntax/types.html#syntax-functype}{\rightarrow} {t_2^\ast})} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~(s \vdash {\href{../exec/runtime.html#syntax-val}{\mathit{val}}} : t_1)^\ast} \\
   \multicolumn{4}{&#64;{}l&#64;{}}{\qquad\quad {\land}~f = \{ \begin{array}[t]{&#64;{}l&#64;{}}
\href{../exec/runtime.html#syntax-frame}{\mathsf{module}}~\{ \begin{array}[t]{&#64;{}l&#64;{}}
 \}\end{array} \}\end{array}} \\
\end{array}\end{split}\]</div>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2017-2024, WebAssembly Community Group.
      
    </div>

    

    
  </body>
</html>